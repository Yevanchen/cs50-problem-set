<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Geolocation API å®ç°åŸç†æ·±åº¦è§£æ</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .layer { background: #f0f8ff; margin: 15px 0; padding: 20px; border-radius: 8px; border-left: 5px solid #2196F3; }
        .code-block { background: #f8f8f8; padding: 15px; border-radius: 5px; font-family: monospace; overflow-x: auto; margin: 10px 0; }
        .highlight { background: #ffffcc; padding: 2px 4px; border-radius: 3px; }
        .browser-impl { background: #e8f5e8; border-left-color: #4caf50; }
        .os-impl { background: #fff3e0; border-left-color: #ff9800; }
        .hardware-impl { background: #fce4ec; border-left-color: #e91e63; }
        h1, h2, h3 { color: #333; }
    </style>
</head>
<body>
    <h1>ğŸ” navigator.geolocation.getCurrentPosition() å®ç°åŸç†</h1>
    
    <h2>ğŸ“š å¤šå±‚å®ç°æ¶æ„</h2>
    
    <div class="layer">
        <h3>ğŸŒ ç¬¬1å±‚ï¼šW3Cæ ‡å‡† - JavaScript APIæ¥å£</h3>
        <p><strong>å®šä¹‰ä½ç½®ï¼š</strong> W3C Geolocation API è§„èŒƒ</p>
        <div class="code-block">
// W3Cæ ‡å‡†å®šä¹‰çš„æ¥å£
interface Navigator {
    readonly attribute Geolocation geolocation;
}

interface Geolocation {
    void getCurrentPosition(PositionCallback successCallback,
                          optional PositionErrorCallback errorCallback,
                          optional PositionOptions options);
}</div>
        <p>ğŸ“„ <strong>æ ‡å‡†æ–‡æ¡£ï¼š</strong> https://www.w3.org/TR/geolocation-API/\</p\>
    </div>

    <div class="layer browser-impl">
        <h3>ğŸŒ ç¬¬2å±‚ï¼šæµè§ˆå™¨å¼•æ“å®ç°</h3>
        <p><strong>å®ç°ä½ç½®ï¼š</strong> å„å¤§æµè§ˆå™¨çš„JavaScriptå¼•æ“ä¸­</p>
        
        <h4>Chrome/Edge (Chromium):</h4>
        <div class="code-block">
// Chromiumæºç ä½ç½®ï¼š
// third_party/blink/renderer/modules/geolocation/
// - geolocation.cc
// - geolocation.h
// - geolocation_position.cc

// C++ å®ç°ç¤ºä¾‹ï¼ˆç®€åŒ–ï¼‰
void Geolocation::getCurrentPosition(
    V8PositionCallback* success_callback,
    V8PositionErrorCallback* error_callback,
    GeolocationPositionOptions* options
) {
    // è°ƒç”¨åº•å±‚å®šä½æœåŠ¡
    geolocation_service_->GetCurrentPosition(
        /*high_accuracy=*/ options->enableHighAccuracy(),
        /*timeout=*/ options->timeout(),
        /*maximum_age=*/ options->maximumAge(),
        callback
    );
}</div>

        <h4>Firefox (Gecko):</h4>
        <div class="code-block">
// Firefoxæºç ä½ç½®ï¼š
// dom/geolocation/
// - Geolocation.cpp
// - Geolocation.h

// C++ å®ç°
NS_IMETHODIMP 
Geolocation::GetCurrentPosition(
    nsIDOMGeoPositionCallback* callback,
    nsIDOMGeoPositionErrorCallback* errorCallback,
    PositionOptions* options
)</div>

        <h4>Safari (WebKit):</h4>
        <div class="code-block">
// WebKitæºç ä½ç½®ï¼š
// Source/WebCore/Modules/geolocation/
// - Geolocation.cpp
// - GeolocationController.cpp</div>
    </div>

    <div class="layer os-impl">
        <h3>âš™ï¸ ç¬¬3å±‚ï¼šæ“ä½œç³»ç»ŸAPI</h3>
        <p><strong>æµè§ˆå™¨é€šè¿‡æ“ä½œç³»ç»ŸAPIè·å–ä½ç½®æ•°æ®</strong></p>
        
        <h4>macOS (Core Location):</h4>
        <div class="code-block">
// Objective-C API
#import <CoreLocation/CoreLocation.h>

@interface LocationManager : NSObject <CLLocationManagerDelegate>
@property (strong, nonatomic) CLLocationManager *locationManager;
@end

- (void)requestLocation {
    self.locationManager = [[CLLocationManager alloc] init];
    self.locationManager.delegate = self;
    [self.locationManager requestWhenInUseAuthorization];
    [self.locationManager requestLocation];
}</div>

        <h4>Windows (Windows Location API):</h4>
        <div class="code-block">
// C++ Windows API
#include <locationapi.h>

// åˆ›å»ºä½ç½®ç®¡ç†å™¨
ILocation* pLocation = NULL;
CoCreateInstance(CLSID_Location, NULL, CLSCTX_INPROC_SERVER, 
                 IID_ILocation, (LPVOID*)&pLocation);

// è¯·æ±‚ä½ç½®æŠ¥å‘Š
pLocation->RequestPermissions(NULL, reports, count, TRUE);</div>

        <h4>Linux (GeoClue):</h4>
        <div class="code-block">
// D-Bus æ¥å£è°ƒç”¨
// GeoClueæ˜¯Linuxä¸Šçš„åœ°ç†ä½ç½®æœåŠ¡æ¡†æ¶
dbus_g_proxy_call(proxy, "GetPosition", &error,
                  G_TYPE_INVALID,
                  G_TYPE_INT, &fields,
                  G_TYPE_INT, &timestamp,
                  G_TYPE_DOUBLE, &latitude,
                  G_TYPE_DOUBLE, &longitude,
                  G_TYPE_DOUBLE, &altitude,
                  G_TYPE_INVALID);</div>

        <h4>Android:</h4>
        <div class="code-block">
// Java/Kotlin Android API
LocationManager locationManager = 
    (LocationManager) getSystemService(Context.LOCATION_SERVICE);

locationManager.requestLocationUpdates(
    LocationManager.GPS_PROVIDER,
    0, 0, locationListener);</div>

        <h4>iOS:</h4>
        <div class="code-block">
// Swift iOS API
import CoreLocation

let locationManager = CLLocationManager()
locationManager.delegate = self
locationManager.requestWhenInUseAuthorization()
locationManager.requestLocation()</div>
    </div>

    <div class="layer hardware-impl">
        <h3>ğŸ›°ï¸ ç¬¬4å±‚ï¼šç¡¬ä»¶å±‚é¢</h3>
        <p><strong>æ“ä½œç³»ç»Ÿé€šè¿‡ç¡¬ä»¶é©±åŠ¨è·å–åŸå§‹å®šä½æ•°æ®</strong></p>
        
        <h4>GPSèŠ¯ç‰‡:</h4>
        <div class="code-block">
// ä½çº§ç¡¬ä»¶æ¥å£ï¼ˆå†…æ ¸é©±åŠ¨å±‚ï¼‰
// é€šè¿‡UARTã€SPIæˆ–USBä¸GPSèŠ¯ç‰‡é€šä¿¡

// NMEAæ ¼å¼çš„GPSæ•°æ®ç¤ºä¾‹
$GPGGA,123519,4807.038,N,01131.000,E,1,08,0.9,545.4,M,46.9,M,,*47
//      æ—¶é—´    çº¬åº¦      ç»åº¦    è´¨é‡ å«æ˜Ÿæ•° ç²¾åº¦  æµ·æ‹”</div>

        <h4>Wi-Fiæ‰«æ:</h4>
        <div class="code-block">
// Wi-FièŠ¯ç‰‡æ‰«æé™„è¿‘çƒ­ç‚¹
// è·å–BSSID(MACåœ°å€)å’Œä¿¡å·å¼ºåº¦
struct wifi_scan_result {
    uint8_t bssid[6];  // MACåœ°å€
    int16_t rssi;      // ä¿¡å·å¼ºåº¦
    char ssid[32];     // ç½‘ç»œåç§°
};</div>

        <h4>èœ‚çªåŸºç«™:</h4>
        <div class="code-block">
// è·å–é™„è¿‘åŸºç«™ä¿¡æ¯
struct cell_tower {
    uint16_t mcc;  // ç§»åŠ¨å›½å®¶ä»£ç 
    uint16_t mnc;  // ç§»åŠ¨ç½‘ç»œä»£ç   
    uint32_t lac;  // ä½ç½®åŒºåŸŸä»£ç 
    uint32_t cid;  // å°åŒºID
    int16_t rssi;  // ä¿¡å·å¼ºåº¦
};</div>
    </div>

    <h2>ğŸ”„ å®Œæ•´è°ƒç”¨æµç¨‹</h2>
    <div class="layer">
        <h3>ğŸ“‹ ä»JavaScriptåˆ°ç¡¬ä»¶çš„è°ƒç”¨é“¾</h3>
        <div class="code-block">
1. JavaScript: navigator.geolocation.getCurrentPosition(callback)
   â†“
2. æµè§ˆå™¨å¼•æ“: Geolocation::getCurrentPosition() [C++]
   â†“  
3. æƒé™æ£€æŸ¥: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æˆæƒ
   â†“
4. IPCè°ƒç”¨: æµè§ˆå™¨è¿›ç¨‹ â†’ ç³»ç»ŸæœåŠ¡è¿›ç¨‹
   â†“
5. æ“ä½œç³»ç»ŸAPI: CoreLocation/LocationAPI/GeoClue
   â†“
6. ç¡¬ä»¶æŠ½è±¡å±‚: è®¾å¤‡é©±åŠ¨ç¨‹åº
   â†“
7. ç‰©ç†ç¡¬ä»¶: GPSèŠ¯ç‰‡/Wi-FièŠ¯ç‰‡/èœ‚çªèŠ¯ç‰‡
   â†“
8. æ•°æ®è¿”å›: ç¡¬ä»¶ â†’ é©±åŠ¨ â†’ OS â†’ æµè§ˆå™¨ â†’ JavaScript</div>
    </div>

    <h2>ğŸ” æŸ¥çœ‹å®é™…æºç </h2>
    <div class="layer">
        <h3>ğŸ“š å¼€æºæµè§ˆå™¨æºç ä½ç½®</h3>
        <ul>
            <li><strong>Chromium:</strong> https://chromium.googlesource.com/chromium/src/+/main/third_party/blink/renderer/modules/geolocation/\</li\>
            <li><strong>Firefox:</strong> https://hg.mozilla.org/mozilla-central/file/tip/dom/geolocation/\</li\>
            <li><strong>WebKit:</strong> https://github.com/WebKit/WebKit/tree/main/Source/WebCore/Modules/geolocation\</li\>
        </ul>
    </div>

    <h2>ğŸ§ª å®é™…æµ‹è¯•</h2>
    <button onclick="inspectGeolocationAPI()">ğŸ” æ£€æŸ¥å½“å‰æµè§ˆå™¨å®ç°</button>
    <div id="inspection-result"></div>

    <script>
        function inspectGeolocationAPI() {
            const resultDiv = document.getElementById('inspection-result');
            let html = '<h3>ğŸ” å½“å‰æµè§ˆå™¨Geolocation APIå®ç°ä¿¡æ¯:</h3>';
            
            // æ£€æŸ¥APIæ˜¯å¦å­˜åœ¨
            if (navigator.geolocation) {
                html += '<p>âœ… navigator.geolocation å¯ç”¨</p>';
                
                // æ£€æŸ¥æ–¹æ³•
                const methods = ['getCurrentPosition', 'watchPosition', 'clearWatch'];
                methods.forEach(method => {
                    if (typeof navigator.geolocation[method] === 'function') {
                        html += `<p>âœ… ${method}() æ–¹æ³•å¯ç”¨</p>`;
                    } else {
                        html += `<p>âŒ ${method}() æ–¹æ³•ä¸å¯ç”¨</p>`;
                    }
                });
                
                // æµè§ˆå™¨ä¿¡æ¯
                html += `<p><strong>æµè§ˆå™¨:</strong> ${navigator.userAgent}</p>`;
                html += `<p><strong>å¹³å°:</strong> ${navigator.platform}</p>`;
                html += `<p><strong>è¯­è¨€:</strong> ${navigator.language}</p>`;
                
                // æ£€æŸ¥æƒé™API
                if (navigator.permissions) {
                    navigator.permissions.query({name: 'geolocation'}).then(result => {
                        html += `<p><strong>åœ°ç†ä½ç½®æƒé™çŠ¶æ€:</strong> ${result.state}</p>`;
                        resultDiv.innerHTML = html;
                    });
                } else {
                    html += '<p>âš ï¸ Permissions API ä¸æ”¯æŒ</p>';
                    resultDiv.innerHTML = html;
                }
                
            } else {
                html += '<p>âŒ navigator.geolocation ä¸å¯ç”¨</p>';
                resultDiv.innerHTML = html;
            }
        }

        // æ˜¾ç¤ºæµè§ˆå™¨ç‰¹å®šå®ç°ä¿¡æ¯
        window.addEventListener('load', function() {
            console.log('=== Geolocation API å®ç°ä¿¡æ¯ ===');
            console.log('APIå¯¹è±¡:', navigator.geolocation);
            console.log('Constructor:', navigator.geolocation.constructor);
            console.log('Prototype:', Object.getPrototypeOf(navigator.geolocation));
            
            if (navigator.geolocation.getCurrentPosition) {
                console.log('getCurrentPositionæºç :');
                console.log(navigator.geolocation.getCurrentPosition.toString());
            }
        });
    </script>
</body>
</html>
