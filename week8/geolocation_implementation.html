<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Geolocation API 实现原理深度解析</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .layer { background: #f0f8ff; margin: 15px 0; padding: 20px; border-radius: 8px; border-left: 5px solid #2196F3; }
        .code-block { background: #f8f8f8; padding: 15px; border-radius: 5px; font-family: monospace; overflow-x: auto; margin: 10px 0; }
        .highlight { background: #ffffcc; padding: 2px 4px; border-radius: 3px; }
        .browser-impl { background: #e8f5e8; border-left-color: #4caf50; }
        .os-impl { background: #fff3e0; border-left-color: #ff9800; }
        .hardware-impl { background: #fce4ec; border-left-color: #e91e63; }
        h1, h2, h3 { color: #333; }
    </style>
</head>
<body>
    <h1>🔍 navigator.geolocation.getCurrentPosition() 实现原理</h1>
    
    <h2>📚 多层实现架构</h2>
    
    <div class="layer">
        <h3>🌐 第1层：W3C标准 - JavaScript API接口</h3>
        <p><strong>定义位置：</strong> W3C Geolocation API 规范</p>
        <div class="code-block">
// W3C标准定义的接口
interface Navigator {
    readonly attribute Geolocation geolocation;
}

interface Geolocation {
    void getCurrentPosition(PositionCallback successCallback,
                          optional PositionErrorCallback errorCallback,
                          optional PositionOptions options);
}</div>
        <p>📄 <strong>标准文档：</strong> https://www.w3.org/TR/geolocation-API/\</p\>
    </div>

    <div class="layer browser-impl">
        <h3>🌍 第2层：浏览器引擎实现</h3>
        <p><strong>实现位置：</strong> 各大浏览器的JavaScript引擎中</p>
        
        <h4>Chrome/Edge (Chromium):</h4>
        <div class="code-block">
// Chromium源码位置：
// third_party/blink/renderer/modules/geolocation/
// - geolocation.cc
// - geolocation.h
// - geolocation_position.cc

// C++ 实现示例（简化）
void Geolocation::getCurrentPosition(
    V8PositionCallback* success_callback,
    V8PositionErrorCallback* error_callback,
    GeolocationPositionOptions* options
) {
    // 调用底层定位服务
    geolocation_service_->GetCurrentPosition(
        /*high_accuracy=*/ options->enableHighAccuracy(),
        /*timeout=*/ options->timeout(),
        /*maximum_age=*/ options->maximumAge(),
        callback
    );
}</div>

        <h4>Firefox (Gecko):</h4>
        <div class="code-block">
// Firefox源码位置：
// dom/geolocation/
// - Geolocation.cpp
// - Geolocation.h

// C++ 实现
NS_IMETHODIMP 
Geolocation::GetCurrentPosition(
    nsIDOMGeoPositionCallback* callback,
    nsIDOMGeoPositionErrorCallback* errorCallback,
    PositionOptions* options
)</div>

        <h4>Safari (WebKit):</h4>
        <div class="code-block">
// WebKit源码位置：
// Source/WebCore/Modules/geolocation/
// - Geolocation.cpp
// - GeolocationController.cpp</div>
    </div>

    <div class="layer os-impl">
        <h3>⚙️ 第3层：操作系统API</h3>
        <p><strong>浏览器通过操作系统API获取位置数据</strong></p>
        
        <h4>macOS (Core Location):</h4>
        <div class="code-block">
// Objective-C API
#import <CoreLocation/CoreLocation.h>

@interface LocationManager : NSObject <CLLocationManagerDelegate>
@property (strong, nonatomic) CLLocationManager *locationManager;
@end

- (void)requestLocation {
    self.locationManager = [[CLLocationManager alloc] init];
    self.locationManager.delegate = self;
    [self.locationManager requestWhenInUseAuthorization];
    [self.locationManager requestLocation];
}</div>

        <h4>Windows (Windows Location API):</h4>
        <div class="code-block">
// C++ Windows API
#include <locationapi.h>

// 创建位置管理器
ILocation* pLocation = NULL;
CoCreateInstance(CLSID_Location, NULL, CLSCTX_INPROC_SERVER, 
                 IID_ILocation, (LPVOID*)&pLocation);

// 请求位置报告
pLocation->RequestPermissions(NULL, reports, count, TRUE);</div>

        <h4>Linux (GeoClue):</h4>
        <div class="code-block">
// D-Bus 接口调用
// GeoClue是Linux上的地理位置服务框架
dbus_g_proxy_call(proxy, "GetPosition", &error,
                  G_TYPE_INVALID,
                  G_TYPE_INT, &fields,
                  G_TYPE_INT, &timestamp,
                  G_TYPE_DOUBLE, &latitude,
                  G_TYPE_DOUBLE, &longitude,
                  G_TYPE_DOUBLE, &altitude,
                  G_TYPE_INVALID);</div>

        <h4>Android:</h4>
        <div class="code-block">
// Java/Kotlin Android API
LocationManager locationManager = 
    (LocationManager) getSystemService(Context.LOCATION_SERVICE);

locationManager.requestLocationUpdates(
    LocationManager.GPS_PROVIDER,
    0, 0, locationListener);</div>

        <h4>iOS:</h4>
        <div class="code-block">
// Swift iOS API
import CoreLocation

let locationManager = CLLocationManager()
locationManager.delegate = self
locationManager.requestWhenInUseAuthorization()
locationManager.requestLocation()</div>
    </div>

    <div class="layer hardware-impl">
        <h3>🛰️ 第4层：硬件层面</h3>
        <p><strong>操作系统通过硬件驱动获取原始定位数据</strong></p>
        
        <h4>GPS芯片:</h4>
        <div class="code-block">
// 低级硬件接口（内核驱动层）
// 通过UART、SPI或USB与GPS芯片通信

// NMEA格式的GPS数据示例
$GPGGA,123519,4807.038,N,01131.000,E,1,08,0.9,545.4,M,46.9,M,,*47
//      时间    纬度      经度    质量 卫星数 精度  海拔</div>

        <h4>Wi-Fi扫描:</h4>
        <div class="code-block">
// Wi-Fi芯片扫描附近热点
// 获取BSSID(MAC地址)和信号强度
struct wifi_scan_result {
    uint8_t bssid[6];  // MAC地址
    int16_t rssi;      // 信号强度
    char ssid[32];     // 网络名称
};</div>

        <h4>蜂窝基站:</h4>
        <div class="code-block">
// 获取附近基站信息
struct cell_tower {
    uint16_t mcc;  // 移动国家代码
    uint16_t mnc;  // 移动网络代码  
    uint32_t lac;  // 位置区域代码
    uint32_t cid;  // 小区ID
    int16_t rssi;  // 信号强度
};</div>
    </div>

    <h2>🔄 完整调用流程</h2>
    <div class="layer">
        <h3>📋 从JavaScript到硬件的调用链</h3>
        <div class="code-block">
1. JavaScript: navigator.geolocation.getCurrentPosition(callback)
   ↓
2. 浏览器引擎: Geolocation::getCurrentPosition() [C++]
   ↓  
3. 权限检查: 检查用户是否授权
   ↓
4. IPC调用: 浏览器进程 → 系统服务进程
   ↓
5. 操作系统API: CoreLocation/LocationAPI/GeoClue
   ↓
6. 硬件抽象层: 设备驱动程序
   ↓
7. 物理硬件: GPS芯片/Wi-Fi芯片/蜂窝芯片
   ↓
8. 数据返回: 硬件 → 驱动 → OS → 浏览器 → JavaScript</div>
    </div>

    <h2>🔍 查看实际源码</h2>
    <div class="layer">
        <h3>📚 开源浏览器源码位置</h3>
        <ul>
            <li><strong>Chromium:</strong> https://chromium.googlesource.com/chromium/src/+/main/third_party/blink/renderer/modules/geolocation/\</li\>
            <li><strong>Firefox:</strong> https://hg.mozilla.org/mozilla-central/file/tip/dom/geolocation/\</li\>
            <li><strong>WebKit:</strong> https://github.com/WebKit/WebKit/tree/main/Source/WebCore/Modules/geolocation\</li\>
        </ul>
    </div>

    <h2>🧪 实际测试</h2>
    <button onclick="inspectGeolocationAPI()">🔍 检查当前浏览器实现</button>
    <div id="inspection-result"></div>

    <script>
        function inspectGeolocationAPI() {
            const resultDiv = document.getElementById('inspection-result');
            let html = '<h3>🔍 当前浏览器Geolocation API实现信息:</h3>';
            
            // 检查API是否存在
            if (navigator.geolocation) {
                html += '<p>✅ navigator.geolocation 可用</p>';
                
                // 检查方法
                const methods = ['getCurrentPosition', 'watchPosition', 'clearWatch'];
                methods.forEach(method => {
                    if (typeof navigator.geolocation[method] === 'function') {
                        html += `<p>✅ ${method}() 方法可用</p>`;
                    } else {
                        html += `<p>❌ ${method}() 方法不可用</p>`;
                    }
                });
                
                // 浏览器信息
                html += `<p><strong>浏览器:</strong> ${navigator.userAgent}</p>`;
                html += `<p><strong>平台:</strong> ${navigator.platform}</p>`;
                html += `<p><strong>语言:</strong> ${navigator.language}</p>`;
                
                // 检查权限API
                if (navigator.permissions) {
                    navigator.permissions.query({name: 'geolocation'}).then(result => {
                        html += `<p><strong>地理位置权限状态:</strong> ${result.state}</p>`;
                        resultDiv.innerHTML = html;
                    });
                } else {
                    html += '<p>⚠️ Permissions API 不支持</p>';
                    resultDiv.innerHTML = html;
                }
                
            } else {
                html += '<p>❌ navigator.geolocation 不可用</p>';
                resultDiv.innerHTML = html;
            }
        }

        // 显示浏览器特定实现信息
        window.addEventListener('load', function() {
            console.log('=== Geolocation API 实现信息 ===');
            console.log('API对象:', navigator.geolocation);
            console.log('Constructor:', navigator.geolocation.constructor);
            console.log('Prototype:', Object.getPrototypeOf(navigator.geolocation));
            
            if (navigator.geolocation.getCurrentPosition) {
                console.log('getCurrentPosition源码:');
                console.log(navigator.geolocation.getCurrentPosition.toString());
            }
        });
    </script>
</body>
</html>
